<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <title>პროფილის რედაქტირება</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: #111; color: white; font-family: sans-serif; text-align: center; padding: 50px;">

    <h2>ჩემი პროფილი</h2>
    
    <div id="profile-info">
        <img id="avatar-preview" src="default-avatar.png" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid orange;">
        <p>როლი: <span id="user-role" style="color: orange;">მომხმარებელი</span></p>
    </div>

    <br>
    <label>შეცვალე ფოტო:</label><br>
    <input type="file" id="avatarInput" accept="image/*"><br><br>

    <label>ჩემი სტატუსი:</label><br>
    <input type="text" id="statusInput" placeholder="როგორ ხარ?" style="padding: 10px; border-radius: 5px;"><br><br>

    <button onclick="saveProfile()" style="padding: 10px 20px; background: orange; border: none; cursor: pointer; font-weight: bold;">შენახვა</button>

    <script>
        // ჩაწერე შენი მონაცემები აქ:
        const SUPABASE_URL = 'შენი_პროექტის_url';
        const SUPABASE_KEY = 'შენი_anon_key';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 1. ინფორმაციის ჩატვირთვა გვერდის გახსნისას
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert("გთხოვთ გაიაროთ ავტორიზაცია");
                return;
            }

            let { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profile) {
                if (profile.avatar_url) document.getElementById('avatar-preview').src = profile.avatar_url;
                if (profile.status) document.getElementById('statusInput').value = profile.status;
                if (profile.role) document.getElementById('user-role').innerText = profile.role;
            }
        }

        // 2. მონაცემების შენახვა
        async function saveProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            const file = document.getElementById('avatarInput').files[0];
            const status = document.getElementById('statusInput').value;
            
            let avatarUrl = document.getElementById('avatar-preview').src;

            // თუ მომხმარებელმა აირჩია ახალი ფოტო
            if (file) {
                const filePath = `avatars/${user.id}`;
                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, { upsert: true });

                if (uploadError) {
                    alert("ფოტოს ატვირთვა ვერ მოხერხდა");
                    return;
                }

                const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
                avatarUrl = data.publicUrl;
            }

            // მონაცემების განახლება ბაზაში
            const { error } = await supabase
                .from('profiles')
                .update({ 
                    status: status, 
                    avatar_url: avatarUrl 
                })
                .eq('id', user.id);

            if (error) alert("შეცდომა შენახვისას: " + error.message);
            else alert("წარმატებით განახლდა!");
            
            location.reload();
        }

        loadProfile();
    </script>
</body>
</html>
