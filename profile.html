<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜ - OLD MAFIA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #ff4500; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; text-align: center; padding: 40px 20px; }
        .profile-card { background: #0a0a0a; padding: 30px; border-radius: 20px; border: 1px solid #222; max-width: 400px; margin: auto; }
        .p-avatar { width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--red); object-fit: cover; margin-bottom: 20px; }
        .p-nick { font-size: 24px; color: var(--red); font-weight: bold; margin-bottom: 10px; }
        .p-status { color: #888; font-style: italic; margin-bottom: 25px; }
        
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #333; background: #111; color: white; }
        .file-label { display: block; background: #1a1a1a; padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 20px; border: 1px dashed #444; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--red); color: white; font-weight: bold; cursor: pointer; }
        .back-link { display: block; margin-top: 20px; color: #555; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

    <div class="profile-card">
        <img id="p-img" class="p-avatar" src="https://www.pngall.com/wp-content/uploads/5/User-Profile-PNG.png">
        <div id="p-nick" class="p-nick">áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</div>
        <div id="p-status" class="p-status">...</div>

        <div id="edit-zone" style="display:none;">
            <label class="file-label">ğŸ“¸ áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¤áƒáƒ¢áƒ <input type="file" id="file-in" accept="image/*" style="display:none;"></label>
            <input type="text" id="status-in" placeholder="áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜">
            <button onclick="saveProfile()">áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        </div>
        <a href="home.html" class="back-link">â† áƒ£áƒ™áƒáƒœ áƒ“áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒ</a>
    </div>

    <script>
        const _sb = supabase.createClient("https://ftfciebnywbondaiarnc.supabase.co", "sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI");
        
        // áƒ•áƒ˜áƒ’áƒ”áƒ‘áƒ— áƒ•áƒ˜áƒ¡ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ¡ áƒ•áƒ£áƒ§áƒ£áƒ áƒ”áƒ‘áƒ—
        const viewNick = localStorage.getItem('view_profile_of') || "áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜";
        const myNick = localStorage.getItem('username');

        async function loadProfile() {
            document.getElementById('p-nick').innerText = viewNick;
            
            // áƒ—áƒ£ áƒ”áƒ¡ áƒ©áƒ”áƒ›áƒ˜ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜áƒ, áƒ’áƒáƒ›áƒáƒ•áƒáƒ©áƒ˜áƒœáƒáƒ— áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ”áƒ‘áƒ˜
            if(viewNick === myNick) {
                document.getElementById('edit-zone').style.display = 'block';
            }

            // áƒ¬áƒáƒ›áƒáƒ•áƒ˜áƒ¦áƒáƒ— áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ‘áƒáƒ–áƒ˜áƒ“áƒáƒœ
            const { data, error } = await _sb.from('avatars_v3').select('*').eq('nickname', viewNick).single();
            
            if(data) {
                if(data.avatar_url) document.getElementById('p-img').src = data.avatar_url;
                if(data.status) {
                    document.getElementById('p-status').innerText = data.status;
                    document.getElementById('status-in').value = data.status;
                }
            } else {
                document.getElementById('p-status').innerText = "áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ›áƒ˜áƒ—áƒ˜áƒ—áƒ”áƒ‘áƒ£áƒšáƒ˜";
            }
        }

        async function saveProfile() {
            const btn = document.querySelector('button');
            btn.innerText = "áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ...";
            btn.disabled = true;

            const status = document.getElementById('status-in').value;
            const file = document.getElementById('file-in').files[0];
            let url = document.getElementById('p-img').src;

            // 1. áƒ—áƒ£ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ›áƒ áƒáƒ˜áƒ áƒ©áƒ˜áƒ áƒ¤áƒáƒ¢áƒ, áƒáƒ•áƒ¢áƒ•áƒ˜áƒ áƒ—áƒáƒ— Storage-áƒ¨áƒ˜
            if(file) {
                const fileName = `avatar_${Date.now()}_${myNick}`;
                const { data: upData, error: upErr } = await _sb.storage.from('avatars').upload(fileName, file);
                
                if(!upErr) {
                    const { data } = _sb.storage.from('avatars').getPublicUrl(fileName);
                    url = data.publicUrl;
                } else {
                    alert("áƒ¤áƒáƒ¢áƒáƒ¡ áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ!");
                }
            }

            // 2. áƒ’áƒáƒœáƒ•áƒáƒáƒ®áƒšáƒáƒ— áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ avatars_v3 áƒªáƒ®áƒ áƒ˜áƒšáƒ¨áƒ˜
            const { error } = await _sb.from('avatars_v3').upsert({ 
                nickname: myNick, 
                avatar_url: url, 
                status: status 
            });

            if(!error) {
                alert("áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ!");
                location.reload();
            } else {
                alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ˜áƒ¡áƒáƒ¡!");
                btn.innerText = "áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ";
                btn.disabled = false;
            }
        }

        window.onload = loadProfile;
    </script>
</body>
</html>
