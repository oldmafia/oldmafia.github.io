<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLD MAFIA - OFFICIAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main-red: #ff4500; --bg: #000; --dark-panel: #0a0a0a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background: var(--bg); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header { 
            height: 60px; 
            background: #000; 
            border-bottom: 1px solid #222; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px; 
            flex-shrink: 0; 
            z-index: 1000;
        }

        .h-left, .h-right { display: flex; align-items: center; gap: 12px; }
        
        .icon-wrap { 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            position: relative; 
            flex-shrink: 0; 
        }

        .badge { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            background: var(--main-red); 
            color: white; 
            font-size: 10px; 
            padding: 2px 5px; 
            border-radius: 50%; 
            border: 1px solid #000;
            display: none; 
        }

        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            background: #000;
        }

        .msg-row { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 5px; }
        .u-img { width: 42px; height: 42px; border-radius: 50%; border: 1px solid #333; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .m-body { flex: 1; }
        .m-nick { color: var(--main-red); font-weight: bold; font-size: 14px; cursor: pointer; }
        .m-text { color: #ccc; font-size: 14px; background: #111; padding: 10px; border-radius: 0 12px 12px 12px; border-left: 3px solid var(--main-red); line-height: 1.4; word-break: break-word; margin-top: 4px; }

        /* Sidebar - áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ¡áƒ¥áƒ áƒáƒšáƒ˜áƒ— */
        .side-menu { position: fixed; left: -100%; top: 0; width: 280px; height: 100%; background: var(--dark-panel); transition: 0.3s; z-index: 2000; padding: 20px; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .rooms-wrapper { flex: 1; overflow-y: auto; margin-top: 20px; padding-right: 5px; }
        .side-menu.open { left: 0; }
        
        /* áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ˜ */
        .room-item { padding: 14px; color: #aaa; cursor: pointer; border-radius: 8px; margin-bottom: 6px; border: 1px solid transparent; transition: 0.2s; font-size: 14px; }
        .room-item:hover, .active-room { background: #1a1a1a; color: var(--main-red); border-color: #333; font-weight: bold; }

        .right-menu { position: fixed; right: -100%; top: 0; width: 320px; height: 100%; background: var(--dark-panel); transition: 0.3s; z-index: 2000; padding: 20px; border-left: 1px solid #222; overflow-y: auto; }
        .right-open { right: 0; }
        .blur { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1500; }

        .input-box { padding: 12px; background: #000; border-top: 1px solid #222; display: flex; gap: 10px; align-items: center; }
        input#msg-in { flex: 1; background: #111; border: 1px solid #333; color: white; padding: 12px 18px; border-radius: 25px; outline: none; }
        .btn-send { background: var(--main-red); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; flex-shrink: 0; }

        .admin-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="blur" id="blur-bg" onclick="closeMenus()"></div>

    <nav class="side-menu" id="side-nav">
        <h2 style="color:var(--main-red); text-align:center;">OLD MAFIA</h2>
        <div class="rooms-wrapper" id="rooms-box">
            </div>
        <button onclick="logout()" style="width:100%; margin-top:15px; padding:12px; background:#1a0000; color:#ff4444; border:1px solid #400; border-radius:8px; cursor:pointer; font-weight:bold; flex-shrink:0;">ğŸšª áƒ’áƒáƒ¡áƒ•áƒšáƒ</button>
    </nav>

    <aside class="right-menu" id="right-nav">
        <div style="text-align: right; cursor: pointer; color: var(--main-red); font-size: 24px; margin-bottom: 15px;" onclick="closeMenus()">âœ•</div>
        <div id="side-content"></div>
    </aside>

    <header>
        <div class="h-left">
            <div style="cursor:pointer; font-size:24px;" onclick="openSide()">â˜°</div>
            <div id="title-text" style="color:var(--main-red); font-weight:bold; font-size:15px;">ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜</div>
        </div>
        <div class="h-right">
            <div class="icon-wrap" onclick="openInbox()">âœ‰ï¸<span id="p-badge" class="badge">0</span></div>
            <div class="icon-wrap" onclick="openMyProfile()">ğŸ‘¤</div>
        </div>
    </header>

    <div id="messages"></div>

    <div class="input-box">
        <input type="text" id="msg-in" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." onkeypress="if(event.key==='Enter') send()">
        <button class="btn-send" onclick="send()">â¤</button>
    </div>

<script>
    const _sb = supabase.createClient("https://ftfciebnywbondaiarnc.supabase.co", "sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI");
    const myNick = localStorage.getItem('username') || "áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜";
    let curRoom = 'ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜';
    let myRole = "áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜";

    // áƒ–áƒ£áƒ¡áƒ¢áƒáƒ“ 10 áƒáƒ—áƒáƒ®áƒ˜
    const rooms = [
        'ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜', 
        'ğŸ›¡ï¸ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ', 
        'ğŸ’ VIP áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ‘áƒ˜', 
        'ğŸ”’ áƒ¨áƒ˜áƒ¤áƒ áƒáƒ’áƒ áƒáƒ›áƒ', 
        'ğŸ¯ áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ', 
        'ğŸª¢ áƒ©áƒáƒ›áƒáƒ®áƒ áƒ©áƒáƒ‘áƒáƒœáƒ', 
        'ğŸ˜‚ áƒ˜áƒ£áƒ›áƒáƒ áƒ˜', 
        'ğŸµ áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ', 
        'ğŸ–¼ï¸ áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ', 
        'ğŸ¤ áƒ’áƒáƒªáƒœáƒáƒ‘áƒ'
    ];

    function openSide() { document.getElementById('side-nav').classList.add('open'); document.getElementById('blur-bg').style.display='block'; }
    function closeMenus() { 
        document.getElementById('side-nav').classList.remove('open'); 
        document.getElementById('right-nav').classList.remove('right-open'); 
        document.getElementById('blur-bg').style.display='none'; 
    }

    function initRooms() {
        document.getElementById('rooms-box').innerHTML = rooms.map(r => `
            <div class="room-item ${r === curRoom ? 'active-room' : ''}" onclick="changeRoom('${r}')">${r}</div>
        `).join('');
    }

    function changeRoom(r) { 
        curRoom = r; 
        document.getElementById('title-text').innerText = r; 
        initRooms(); 
        closeMenus(); 
        loadMsgs(); 
    }

    async function loadMsgs() {
        const { data: msgs } = await _sb.from('messages_v3').select('*').eq('room_name', curRoom).order('created_at', { ascending: false }).limit(50);
        const { data: avs } = await _sb.from('avatars_v3').select('*');
        let avMap = {}; if(avs) avs.forEach(a => { avMap[a.nickname] = a; if(a.nickname === myNick) myRole = a.role || "áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜"; });

        document.getElementById('messages').innerHTML = msgs?.reverse().map(m => {
            const u = avMap[m.nickname] || {};
            let tag = u.role === 'áƒ“áƒáƒ›áƒ¤áƒ£áƒ«áƒœáƒ”áƒ‘áƒ”áƒšáƒ˜' ? '<span style="font-size:9px; background:#8b0000; padding:2px 5px; border-radius:4px; margin-left:5px; vertical-align:middle; color:white;">FOUNDER</span>' : 
                      u.role === 'áƒáƒ“áƒ›áƒ˜áƒœáƒ˜' ? '<span style="font-size:9px; background:#00008b; padding:2px 5px; border-radius:4px; margin-left:5px; vertical-align:middle; color:white;">ADMIN</span>' : '';
            return `
                <div class="msg-row">
                    <img src="${u.avatar_url || 'https://www.pngall.com/wp-content/uploads/5/User-Profile-PNG.png'}" class="u-img" onclick="openUser('${m.nickname}')">
                    <div class="m-body">
                        <span class="m-nick" onclick="openUser('${m.nickname}')">${m.nickname}</span>${tag}
                        <div class="m-text">${m.message}</div>
                    </div>
                </div>`;
        }).join('') || "";
        const box = document.getElementById('messages');
        box.scrollTop = box.scrollHeight;
    }

    async function openUser(nick) {
        if(nick === myNick) return openMyProfile();
        document.getElementById('right-nav').classList.add('right-open');
        document.getElementById('blur-bg').style.display = 'block';
        const { data: u } = await _sb.from('avatars_v3').select('*').eq('nickname', nick).single();
        
        let adminOps = "";
        if(myRole === 'áƒ“áƒáƒ›áƒ¤áƒ£áƒ«áƒœáƒ”áƒ‘áƒ”áƒšáƒ˜' || myNick === 'abu007') {
            adminOps = `<div style="margin-top:20px; border-top:1px solid #222; padding-top:10px;">
                <p style="font-size:10px; color:gray; margin-bottom:10px;">áƒáƒ“áƒ›áƒ˜áƒœ áƒáƒáƒœáƒ”áƒšáƒ˜:</p>
                <button class="admin-btn" style="background:#8b0000;" onclick="setR('${nick}','áƒ“áƒáƒ›áƒ¤áƒ£áƒ«áƒœáƒ”áƒ‘áƒ”áƒšáƒ˜')">Founder</button>
                <button class="admin-btn" style="background:#00008b;" onclick="setR('${nick}','áƒáƒ“áƒ›áƒ˜áƒœáƒ˜')">Admin</button>
                <button class="admin-btn" style="background:#333;" onclick="setR('${nick}','áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜')">User</button>
            </div>`;
        }

        document.getElementById('side-content').innerHTML = `
            <div style="text-align:center;">
                <img src="${u?.avatar_url || 'https://www.pngall.com/wp-content/uploads/5/User-Profile-PNG.png'}" style="width:110px; height:110px; border-radius:50%; border:3px solid var(--main-red); object-fit:cover;">
                <h2 style="margin:15px 0 5px 0;">${nick}</h2>
                <p style="color:var(--main-red); font-weight:bold; font-size:13px; text-transform:uppercase;">${u?.role || 'áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜'}</p>
                <p style="color:#888; font-size:12px; margin-top:10px; font-style:italic;">${u?.status || ''}</p>
                
                <div style="margin-top:25px; background:#111; padding:15px; border-radius:12px; text-align:left; border:1px solid #222;">
                    <p style="font-size:11px; color:#555; margin-bottom:10px; font-weight:bold; text-transform:uppercase;">áƒ›áƒ˜áƒ¬áƒ”áƒ áƒ” áƒáƒ˜áƒ áƒáƒ“áƒáƒ“:</p>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="p-txt" placeholder="..." style="flex:1; background:#000; border:1px solid #333; color:white; padding:12px; border-radius:8px; outline:none;">
                        <button onclick="sendP('${nick}')" style="background:var(--main-red); border:none; padding:12px; border-radius:8px; color:white; font-weight:bold;">â¤</button>
                    </div>
                </div>
                ${adminOps}
            </div>`;
    }

    async function sendP(to) {
        const val = document.getElementById('p-txt').value.trim();
        if(!val) return;
        const room = [myNick, to].sort().join('_PM_');
        await _sb.from('messages_v3').insert([{ nickname: myNick, message: val, room_name: room }]);
        alert("áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ áƒ’áƒáƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ " + to + "-áƒ—áƒáƒœ!"); 
        closeMenus();
    }

    async function openInbox() {
        document.getElementById('right-nav').classList.add('right-open');
        document.getElementById('blur-bg').style.display = 'block';
        const { data } = await _sb.from('messages_v3').select('*').ilike('room_name', `%_PM_%${myNick}%`).neq('nickname', myNick).order('created_at', {ascending: false});
        let users = {}; if(data) data.forEach(m => { if(!users[m.nickname]) users[m.nickname] = m.message; });
        
        document.getElementById('side-content').innerHTML = `
            <h3 style="color:var(--main-red); margin-bottom:20px; border-bottom:1px solid #222; padding-bottom:10px;">âœ‰ï¸ áƒ¨áƒ”áƒ›áƒáƒáƒáƒ¡áƒ£áƒšáƒ”áƒ‘áƒ˜</h3>
            ${Object.keys(users).length > 0 ? Object.keys(users).map(u => `
                <div style="background:#111; padding:15px; border-radius:10px; margin-bottom:10px; border-left:4px solid var(--main-red); cursor:pointer;" onclick="openUser('${u}')">
                    <div style="font-weight:bold; margin-bottom:3px;">${u}</div>
                    <div style="font-size:12px; color:#777; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${users[u]}</div>
                </div>
            `).join('') : '<p style="color:#555; text-align:center;">áƒ¬áƒ”áƒ áƒ˜áƒšáƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡</p>'}
        `;
    }

    async function setR(n, r) { 
        await _sb.from('avatars_v3').update({ role: r }).eq('nickname', n); 
        alert("áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ: " + r);
        location.reload(); 
    }

    async function send() {
        const inp = document.getElementById('msg-in'); if(!inp.value.trim()) return;
        await _sb.from('messages_v3').insert([{ nickname: myNick, message: inp.value, room_name: curRoom }]);
        inp.value = ""; 
        loadMsgs();
    }

    async function openMyProfile() {
        const { data: u } = await _sb.from('avatars_v3').select('*').eq('nickname', myNick).single();
        document.getElementById('right-nav').classList.add('right-open');
        document.getElementById('blur-bg').style.display = 'block';
        document.getElementById('side-content').innerHTML = `
            <div style="text-align:center;">
                <img src="${u?.avatar_url || 'https://www.pngall.com/wp-content/uploads/5/User-Profile-PNG.png'}" style="width:110px; height:110px; border-radius:50%; border:3px solid var(--main-red); object-fit:cover;">
                <h2 style="margin:10px 0;">${myNick}</h2>
                <p style="color:var(--main-red); font-size:12px; margin-bottom:20px;">áƒ¨áƒ”áƒœáƒ˜ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜</p>
                <textarea id="my-st" placeholder="áƒ¨áƒ”áƒœáƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜..." style="width:100%; height:80px; padding:12px; background:#111; border:1px solid #333; color:white; border-radius:10px; outline:none; resize:none;">${u?.status || ''}</textarea>
                <button onclick="saveSt()" style="width:100%; padding:14px; background:var(--main-red); color:white; border:none; border-radius:10px; margin-top:15px; font-weight:bold; cursor:pointer;">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            </div>`;
    }

    async function saveSt() { 
        await _sb.from('avatars_v3').upsert({ nickname: myNick, status: document.getElementById('my-st').value }); 
        location.reload(); 
    }

    function logout() { localStorage.removeItem('username'); location.href = 'index.html'; }

    window.onload = () => { 
        initRooms(); 
        loadMsgs(); 
        setInterval(loadMsgs, 4000); 
    };
</script>
</body>
</html>
