<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLD MAFIA - áƒ©áƒáƒ¢áƒ˜</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon-red: #ff0000; --wine-red: #8b0000; --bg-black: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-black); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        .header {
            height: 60px; background: #111; border-bottom: 2px solid var(--neon-red);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            z-index: 100; box-shadow: 0 0 15px rgba(255,0,0,0.3);
        }
        #display-nick { color: var(--neon-red); font-weight: bold; font-size: 14px; }

        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #000; }
        #chat-window { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        /* áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ˜áƒ–áƒáƒ˜áƒœáƒ˜ */
        .msg-box { 
            background: #111; padding: 12px; border-radius: 12px; 
            max-width: 85%; border-left: 4px solid var(--neon-red); 
            position: relative; align-self: flex-start;
            word-wrap: break-word;
        }
        .msg-box b { color: var(--neon-red); font-size: 11px; display: block; margin-bottom: 4px; }
        .del-btn { color: #444; font-size: 14px; cursor: pointer; position: absolute; right: 8px; top: 8px; font-weight: bold; }
        .del-btn:hover { color: var(--neon-red); }

        /* áƒ’áƒ•áƒ”áƒ áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒáƒáƒœáƒ”áƒšáƒ˜ */
        .pagination { 
            display: flex; justify-content: center; gap: 8px; padding: 8px; 
            background: #080808; border-top: 1px solid #222; flex-wrap: wrap;
        }
        .page-btn { 
            padding: 4px 10px; background: #111; border: 1px solid #444; 
            color: #ccc; cursor: pointer; border-radius: 4px; font-size: 12px;
        }
        .page-btn.active { background: var(--neon-red); color: white; border-color: var(--neon-red); box-shadow: 0 0 5px var(--neon-red); }

        /* áƒ¥áƒ•áƒ”áƒ“áƒ áƒœáƒáƒ¬áƒ˜áƒšáƒ˜ */
        .footer { padding: 12px; background: #0a0a0a; display: flex; gap: 10px; align-items: center; border-top: 1px solid #111; }
        input { flex: 1; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px 15px; border-radius: 20px; outline: none; }
        .send-btn { background: var(--neon-red); border: none; width: 42px; height: 42px; border-radius: 50%; color: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px var(--neon-red); }
    </style>
</head>
<body>

    <header class="header">
        <div style="color: var(--neon-red); font-weight: bold; letter-spacing: 1px;">OLD MAFIA</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span id="display-nick">...</span>
            <div style="font-size: 18px;">ğŸ‘¤</div>
        </div>
    </header>

    <div class="chat-container">
        <div id="chat-window">
            </div>

        <div class="pagination" id="pagination">
            </div>

        <div class="footer">
            <input type="text" id="message-input" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." onkeypress="if(event.key==='Enter')sendMessage()">
            <button class="send-btn" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            "https://ftfciebnywbondaiarnc.supabase.co",
            "sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI"
        );

        const myNick = localStorage.getItem('username') || "áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜";
        document.getElementById('display-nick').innerText = myNick;

        let currentPage = 1;
        const messagesPerPage = 15; // áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ¡ áƒ”áƒ áƒ— áƒ’áƒ•áƒ”áƒ áƒ“áƒ–áƒ”

        async function loadMessages(page = 1) {
            currentPage = page;
            const from = (page - 1) * messagesPerPage;
            const to = from + messagesPerPage - 1;

            const { data, error, count } = await supabaseClient
                .from('messages')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false })
                .range(from, to);

            if (error) { console.log(error); return; }

            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = "";

            // áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜ (áƒ§áƒáƒ•áƒ”áƒšáƒ—áƒ•áƒ˜áƒ¡ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜áƒ áƒáƒ˜áƒ áƒ•áƒ”áƒš áƒ’áƒ•áƒ”áƒ áƒ“áƒ–áƒ”)
            if(page === 1) {
                chatWindow.innerHTML = `
                    <div class="msg-box" style="border-left-color: gold;">
                        <b>áƒáƒ“áƒ›áƒ˜áƒœáƒ˜:</b> áƒáƒ¥ áƒ©áƒ•áƒ”áƒœáƒ˜ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜áƒ!!!! âš ï¸<br>áƒáƒ  áƒ¨áƒ”áƒ˜áƒ’áƒ˜áƒœáƒáƒ— áƒ“áƒ áƒ˜áƒ§áƒáƒ•áƒ˜áƒ— áƒ™áƒáƒ áƒ’áƒáƒ“! ğŸ˜ğŸ·
                    </div>
                `;
            }

            // áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ¢áƒáƒœáƒ
            data.reverse().forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = "msg-box";
                
                // áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ¨áƒ”áƒœáƒ—áƒ•áƒ˜áƒ¡ (abu007)
                let deleteHtml = "";
                if (myNick === "abu007") {
                    deleteHtml = `<span class="del-btn" onclick="deleteMsg('${msg.id}')">âœ–</span>`;
                }

                msgDiv.innerHTML = `<b>${msg.nickname}:</b> ${deleteHtml} <div>${msg.content}</div>`;
                chatWindow.appendChild(msgDiv);
            });

            renderPagination(count);
            // áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒ©áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ áƒ“áƒáƒ‘áƒšáƒ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ˜áƒ áƒ•áƒ”áƒš áƒ’áƒ•áƒ”áƒ áƒ“áƒ–áƒ”
            if(page === 1) chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function renderPagination(totalCount) {
            const totalPages = Math.ceil(totalCount / messagesPerPage);
            const pgContainer = document.getElementById('pagination');
            pgContainer.innerHTML = "";

            if(totalPages <= 1) return; // áƒ—áƒ£ áƒªáƒáƒ¢áƒ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜áƒ, áƒ’áƒ•áƒ”áƒ áƒ“áƒ”áƒ‘áƒ˜ áƒáƒ  áƒ’áƒ•áƒ˜áƒœáƒ“áƒ

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.innerText = i;
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.onclick = () => loadMessages(i);
                pgContainer.appendChild(btn);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = ""; 
            const { error } = await supabaseClient
                .from('messages')
                .insert([{ nickname: myNick, content: text }]);

            if (error) alert("áƒ•áƒ”áƒ  áƒ’áƒáƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ!");
        }

        async function deleteMsg(id) {
            if (confirm("áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ¬áƒáƒ•áƒ¨áƒáƒšáƒ áƒ”áƒ¡ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜?")) {
                await supabaseClient.from('messages').delete().eq('id', id);
                loadMessages(currentPage);
            }
        }

        // áƒ áƒ”áƒáƒšáƒ£áƒ  áƒ“áƒ áƒáƒ¨áƒ˜ áƒ›áƒáƒ¡áƒ›áƒ”áƒœáƒ (Realtime)
        supabaseClient
            .channel('any')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                loadMessages(currentPage);
            })
            .subscribe();

        // áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ
        loadMessages();
    </script>
</body>
</html>
