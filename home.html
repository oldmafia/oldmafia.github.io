<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLD MAFIA - áƒ©áƒáƒ¢áƒ˜</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon-red: #ff0000; --wine-red: #8b0000; --bg-black: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-black); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* áƒ°áƒ”áƒ“áƒ”áƒ áƒ˜ */
        .header {
            height: 60px; background: #111; border-bottom: 2px solid var(--neon-red);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            z-index: 1000; 
        }
        .menu-btn { font-size: 30px; color: var(--neon-red); cursor: pointer; }
        .room-indicator { font-weight: bold; color: var(--neon-red); font-size: 14px; text-transform: uppercase; }

        /* áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜áƒ—áƒ áƒ›áƒ”áƒœáƒ˜áƒ£ */
        .sidebar {
            position: fixed; left: -100%; top: 0; width: 280px; height: 100%;
            background: #0d0d0d; border-right: 2px solid var(--neon-red);
            transition: 0.3s; z-index: 2000; padding: 20px;
            display: flex; flex-direction: column; gap: 8px;
            overflow-y: auto;
        }
        .sidebar.open { left: 0; }
        .sidebar-header { color: var(--neon-red); font-weight: bold; font-size: 20px; text-align: center; padding-bottom: 15px; border-bottom: 1px solid #222; margin-bottom: 10px; }

        .nav-link {
            display: flex; align-items: center; padding: 12px; color: white; text-decoration: none;
            background: #1a1a1a; border: 1px solid #333; border-radius: 10px; font-size: 15px;
        }
        .nav-link.active { background: var(--wine-red); border-color: var(--neon-red); box-shadow: 0 0 10px rgba(255,0,0,0.3); }

        /* áƒ©áƒáƒ¢áƒ˜ */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: black; position: relative; }
        #chat-window { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg-box { background: #111; padding: 10px; border-radius: 12px; max-width: 85%; border-left: 4px solid var(--neon-red); position: relative; align-self: flex-start; word-wrap: break-word; }
        .msg-box b { color: var(--neon-red); font-size: 11px; display: block; }
        .del-btn { color: #555; position: absolute; right: 8px; top: 8px; cursor: pointer; font-weight: bold; }

        .pagination { display: flex; justify-content: center; gap: 5px; padding: 10px; background: #000; border-top: 1px solid #111; }
        .page-btn { padding: 5px 10px; background: #111; border: 1px solid #444; color: white; cursor: pointer; border-radius: 5px; font-size: 12px; }
        .page-btn.active { background: var(--neon-red); }

        /* áƒ˜áƒœáƒáƒ£áƒ¢áƒ˜ */
        .footer { padding: 12px; background: #0a0a0a; display: flex; align-items: center; gap: 10px; border-top: 1px solid #222; }
        .input-wrap { flex: 1; background: #1a1a1a; border-radius: 20px; padding: 5px 15px; border: 1px solid #333; }
        input { width: 100%; background: transparent; border: none; color: white; padding: 8px; outline: none; }
        .send-btn { background: var(--neon-red); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* áƒ¡áƒ›áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜ */
        .emoji-panel { display: none; position: absolute; bottom: 80px; left: 15px; background: #111; border: 1px solid var(--neon-red); padding: 10px; border-radius: 10px; grid-template-columns: repeat(5, 1fr); gap: 10px; z-index: 1001; }
        .emoji-panel span { font-size: 24px; cursor: pointer; }

        /* áƒ›áƒ”áƒœáƒ˜áƒ£áƒ¡ áƒ©áƒáƒ›áƒ™áƒ”áƒ¢áƒ˜ áƒ¤áƒáƒœáƒ˜ */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1500; }
        .overlay.active { display: block; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <header class="header">
        <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
        <div class="room-indicator" id="currentRoom">áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜</div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span id="display-nick" style="font-size: 13px; color: #fff; font-weight: bold;">...</span>
            ğŸ‘¤
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">MAFIA ROOMS</div>
        <a href="#" class="nav-link active" onclick="changeRoom('áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜', this)">ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ•áƒ˜áƒ áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ‘áƒ˜', this)">ğŸ’ áƒ•áƒ˜áƒ áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ‘áƒ˜</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ¨áƒ˜áƒ¤áƒ áƒáƒ’áƒ áƒáƒ›áƒ', this)">ğŸ” áƒ¨áƒ˜áƒ¤áƒ áƒáƒ’áƒ áƒáƒ›áƒ</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ', this)">ğŸ¯ áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ˜áƒáƒ áƒáƒ¦áƒ˜áƒ¡ áƒáƒ—áƒáƒ®áƒ˜', this)">âš”ï¸ áƒ˜áƒáƒ áƒáƒ¦áƒ˜áƒ¡ áƒáƒ—áƒáƒ®áƒ˜</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ', this)">ğŸ–¼ï¸ áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ', this)">ğŸµ áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ</a>
        <a href="#" class="nav-link" onclick="changeRoom('áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ', this)">ğŸ†˜ áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ</a>
        
        <a href="index.html" class="nav-link" style="margin-top: 20px; border-color: #444; color: #888; font-size: 14px;">ğŸšª áƒ’áƒáƒ¡áƒ•áƒšáƒ</a>
    </nav>

    <div class="chat-container">
        <div id="chat-window"></div>
        <div class="pagination" id="pagination"></div>

        <div class="emoji-panel" id="emojiPanel">
            <span onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span> <span onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span>
            <span onclick="addEmoji('ğŸ˜')">ğŸ˜</span> <span onclick="addEmoji('ğŸ”«')">ğŸ”«</span>
            <span onclick="addEmoji('ğŸ·')">ğŸ·</span> <span onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
            <span onclick="addEmoji('ğŸ’€')">ğŸ’€</span> <span onclick="addEmoji('âš ï¸')">âš ï¸</span>
            <span onclick="addEmoji('ğŸ¤«')">ğŸ¤«</span> <span onclick="addEmoji('ğŸ’¸')">ğŸ’¸</span>
        </div>

        <div class="footer">
            <span style="font-size: 24px; cursor: pointer;" onclick="toggleEmoji()">ğŸ˜Š</span>
            <div class="input-wrap">
                <input type="text" id="message-input" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." autocomplete="off" onkeypress="if(event.key==='Enter')sendMessage()">
            </div>
            <button class="send-btn" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient("https://ftfciebnywbondaiarnc.supabase.co", "sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI");

        let myNick = localStorage.getItem('username');
        if (!myNick) { window.location.href = "index.html"; }
        document.getElementById('display-nick').innerText = myNick;

        let currentRoom = 'áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜';
        const messagesPerPage = 15;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function changeRoom(name, el) {
            currentRoom = name;
            document.getElementById('currentRoom').innerText = name;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
            toggleSidebar();
            loadMessages(1);
        }

        function toggleEmoji() { const p = document.getElementById('emojiPanel'); p.style.display = (p.style.display === 'grid') ? 'none' : 'grid'; }
        function addEmoji(e) { document.getElementById('message-input').value += e; document.getElementById('message-input').focus(); }

        async function loadMessages(page = 1) {
            const from = (page - 1) * messagesPerPage;
            const to = from + messagesPerPage - 1;

            const { data, error, count } = await supabaseClient
                .from('messages')
                .select('*', { count: 'exact' })
                .eq('room_id', currentRoom)
                .order('created_at', { ascending: false })
                .range(from, to);

            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = "";
            
            if(page === 1) {
                chatWindow.innerHTML = `<div class="msg-box" style="border-left-color: gold;"><b>áƒáƒ“áƒ›áƒ˜áƒœáƒ˜:</b> áƒ›áƒáƒ’áƒ”áƒ¡áƒáƒšáƒ›áƒ”áƒ‘áƒ˜áƒ— ${currentRoom}-áƒ¨áƒ˜! âš ï¸<br>áƒ“áƒáƒ˜áƒªáƒáƒ•áƒ˜áƒ— áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜! ğŸ·</div>`;
            }

            if (data) {
                data.reverse().forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = "msg-box";
                    if(msg.nickname === myNick) msgDiv.style.background = "#1a0a0a";
                    let del = (myNick === 'abu007') ? `<span class="del-btn" onclick="deleteMsg('${msg.id}')">âœ–</span>` : "";
                    msgDiv.innerHTML = `<b>${msg.nickname}:</b> ${del} <div>${msg.content}</div>`;
                    chatWindow.appendChild(msgDiv);
                });
            }
            renderPagination(count, page);
            if(page === 1) chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function renderPagination(total, current) {
            const pages = Math.ceil(total / messagesPerPage);
            const container = document.getElementById('pagination');
            container.innerHTML = "";
            if(pages <= 1) return;
            for(let i=1; i<=pages; i++) {
                const b = document.createElement('button');
                b.innerText = i; b.className = `page-btn ${i===current?'active':''}`;
                b.onclick = () => loadMessages(i);
                container.appendChild(b);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            if(!input.value.trim()) return;
            const text = input.value;
            input.value = "";
            document.getElementById('emojiPanel').style.display = 'none';
            await supabaseClient.from('messages').insert([{ nickname: myNick, content: text, room_id: currentRoom }]);
        }

        async function deleteMsg(id) {
            if(confirm("áƒ¬áƒáƒ•áƒ¨áƒáƒšáƒáƒ—?")) {
                await supabaseClient.from('messages').delete().eq('id', id);
                loadMessages(1);
            }
        }

        supabaseClient.channel('realtime').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
            loadMessages(1);
        }).subscribe();

        loadMessages(1);
    </script>
</body>
</html>
