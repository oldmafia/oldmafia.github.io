<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLD MAFIA - PRO AVATAR</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #ff0000; --bg: #050505; --dark: #121212; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Profile Modal */
        .p-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 340px; background: #0a0a0a; border: 1px solid var(--red); border-radius: 25px; z-index: 6000; padding: 25px; text-align: center; box-shadow: 0 0 30px rgba(255,0,0,0.2); }
        
        /* áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ˜ - áƒ áƒáƒ› áƒáƒ áƒáƒ¡áƒ“áƒ áƒáƒ¡ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ¡ áƒ£áƒ¨áƒœáƒáƒ“ */
        .p-avatar-wrapper { position: relative; width: 110px; height: 110px; margin: 0 auto 15px; }
        .p-avatar { 
            width: 110px; height: 110px; 
            border-radius: 50%; 
            border: 3px solid var(--red); 
            object-fit: cover; /* áƒ”áƒ¡ áƒ£áƒ–áƒ áƒ£áƒœáƒ•áƒ”áƒšáƒ§áƒáƒ¤áƒ¡ áƒ áƒáƒ› áƒ¤áƒáƒ¢áƒ áƒáƒ  áƒ’áƒáƒ˜áƒ¬áƒ”áƒšáƒáƒ¡ */
            background: #151515;
            display: block;
        }
        .upload-label { 
            position: absolute; bottom: 5px; right: 5px; 
            background: var(--red); color: white; 
            width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 14px; border: 2px solid #000;
        }

        .p-nick { font-size: 22px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .p-role { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; padding: 4px 12px; border-radius: 15px; background: #222; margin-bottom: 15px; display: inline-block; }
        .role-owner { background: #8b0000; color: #ffd700; border: 1px solid #ffd700; }

        /* áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ˜áƒ¡ áƒ‘áƒšáƒáƒ™áƒ˜ */
        .p-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; background: #111; padding: 10px; border-radius: 15px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-num { color: var(--red); font-weight: bold; font-size: 16px; }
        .stat-label { font-size: 9px; color: #666; margin-top: 3px; }

        /* áƒ¡áƒáƒ©áƒ£áƒ¥áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ–áƒáƒœáƒ */
        .gift-container { background: #000; border: 1px solid #222; border-radius: 12px; padding: 10px; min-height: 50px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; }
        .gift-img { font-size: 20px; }

        .btn-close { margin-top: 20px; background: transparent; border: none; color: #555; cursor: pointer; font-size: 14px; }
        
        /* Chat elements */
        #chat-window { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { background: var(--dark); padding: 10px 15px; border-radius: 15px; border: 1px solid #222; align-self: flex-start; max-width: 85%; }
        .nick-tag { color: var(--red); font-size: 12px; font-weight: bold; cursor: pointer; margin-bottom: 4px; display: block; }
        
        .footer { padding: 15px; background: #000; border-top: 1px solid #222; padding-bottom: 35px; }
        .input-wrapper { display: flex; gap: 10px; }
        input { flex: 1; background: #111; border: 1px solid #333; color: white; padding: 12px 18px; border-radius: 25px; outline: none; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1500; }
    </style>
</head>
<body>

    <div class="overlay" id="p-overlay" onclick="closeProfile()"></div>

    <div class="p-modal" id="p-modal">
        <div class="p-avatar-wrapper">
            <img src="https://i.pinimg.com/originals/f1/0f/f7/f10ff70a715515ab166ae319da3f2743.png" class="p-avatar" id="p-img">
            
            <label for="file-upload" class="upload-label" id="upload-btn">
                ğŸ“·
            </label>
            <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="previewFile()">
        </div>

        <div class="p-nick" id="p-nick">User</div>
        <div class="p-role" id="p-role">áƒ¬áƒ”áƒ•áƒ áƒ˜</div>

        <div class="p-stats-grid">
            <div class="stat-item"><span class="stat-num" id="s-vict">0</span><span class="stat-label">áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ</span></div>
            <div class="stat-item"><span class="stat-num" id="s-shif">0</span><span class="stat-label">áƒ¨áƒ˜áƒ¤áƒ áƒ</span></div>
            <div class="stat-item"><span class="stat-num" id="s-hang">0</span><span class="stat-label">áƒ©áƒáƒ›áƒáƒ®áƒ áƒ©</span></div>
        </div>

        <div style="text-align: left; font-size: 10px; color: var(--red); margin-left: 5px;">áƒ¡áƒáƒ©áƒ£áƒ¥áƒ áƒ”áƒ‘áƒ˜:</div>
        <div class="gift-container" id="p-gifts">
            <span class="gift-img">ğŸ</span>
        </div>

        <button class="btn-close" onclick="closeProfile()">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
    </div>

    <header style="height: 55px; border-bottom: 1px solid red; display: flex; justify-content: space-between; align-items: center; padding: 0 15px;">
        <div style="font-size:24px; color:red;">â˜°</div>
        <div style="font-weight:bold; color:red;">OLD MAFIA</div>
        <div onclick="showMyProfile()" style="font-size:24px; cursor:pointer;">ğŸ‘¤</div>
    </header>

    <div id="chat-window"></div>

    <div class="footer">
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ”..." onkeypress="if(event.key==='Enter')send()">
            <button style="background:red; border:none; width:45px; border-radius:50%; color:white;" onclick="send()">â¤</button>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const client = createClient("https://ftfciebnywbondaiarnc.supabase.co", "sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI");

        let myNick = localStorage.getItem('username') || "Anon";

        function openProfile(nick) {
            document.getElementById('p-nick').innerText = nick;
            document.getElementById('p-modal').style.display = 'block';
            document.getElementById('p-overlay').style.display = 'block';

            // áƒ—áƒ£ áƒ©áƒ”áƒ›áƒ˜ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜áƒ, áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ¡ áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ˜
            document.getElementById('upload-btn').style.display = (nick === myNick) ? 'flex' : 'none';
            
            if(nick === "Gemini" || nick === "Damaarsebeli") {
                document.getElementById('p-role').innerText = "áƒ“áƒáƒ›áƒáƒáƒ áƒ¡áƒ”áƒ‘áƒ”áƒšáƒ˜";
                document.getElementById('p-role').className = "p-role role-owner";
            } else {
                document.getElementById('p-role').innerText = "áƒ˜áƒ£áƒ–áƒ”áƒ áƒ˜";
                document.getElementById('p-role').className = "p-role role-user";
            }
        }

        function closeProfile() {
            document.getElementById('p-modal').style.display = 'none';
            document.getElementById('p-overlay').style.display = 'none';
        }

        function showMyProfile() { openProfile(myNick); }

        // áƒ¤áƒáƒ¢áƒáƒ¡ áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ˜áƒ¡ áƒ“áƒ áƒ’áƒáƒ›áƒáƒ©áƒ”áƒœáƒ˜áƒ¡ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ
        function previewFile() {
            const file = document.querySelector('#file-upload').files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                document.getElementById('p-img').src = reader.result;
                // áƒáƒ¥ áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ reader.result (base64) áƒ‘áƒáƒ–áƒáƒ¨áƒ˜, áƒ áƒáƒ› áƒ›áƒ”áƒ áƒ” áƒ¡áƒ®áƒ•áƒ”áƒ‘áƒ›áƒáƒª áƒ“áƒáƒ˜áƒœáƒáƒ®áƒáƒœ
                localStorage.setItem('user_avatar_' + myNick, reader.result);
            }

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        // áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ”áƒ‘áƒ˜
        async function load() {
            const { data } = await client.from('messages_v3').select('*').order('created_at', { ascending: false }).limit(30);
            if(data) {
                document.getElementById('chat-window').innerHTML = data.reverse().map(m => `
                    <div class="msg">
                        <span class="nick-tag" onclick="openProfile('${m.nickname}')">${m.nickname}</span>
                        <div>${m.content}</div>
                    </div>
                `).join('');
                document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
            }
        }

        async function send() {
            const el = document.getElementById('msg-input');
            if(!el.value.trim()) return;
            await client.from('messages_v3').insert([{ nickname: myNick, content: el.value, room_name: 'áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜' }]);
            el.value = ""; load();
        }

        // áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜ áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒáƒ¦áƒ“áƒ’áƒ”áƒœáƒ
        window.onload = () => {
            const savedAvatar = localStorage.getItem('user_avatar_' + myNick);
            if(savedAvatar) document.getElementById('p-img').src = savedAvatar;
            load();
        };

        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'messages_v3' }, load).subscribe();
    </script>
</body>
</html>
