<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OLD MAFIA</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root { --red:#ff4500; --bg:#050505; --gold:#ffd700; --admin:#00ccff; }
body { margin:0; background:var(--bg); color:white; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
header { height:55px; background:#000; display:flex; align-items:center; justify-content:space-between; padding:0 15px; border-bottom:1px solid #222; }
.sidebar { position:fixed; left:-100%; top:0; width:270px; height:100%; background:#000; padding:20px; transition:.3s; z-index:1000; overflow:auto; }
.sidebar.open{ left:0; }
.nav-item { padding:10px; margin-bottom:8px; border-radius:8px; background:#111; cursor:pointer; }
.nav-item.active { background:var(--red); font-weight:bold; }
#chat-window { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
.msg { background:#1a1a1a; padding:10px; border-radius:12px; max-width:85%; }
.sender { font-size:12px; font-weight:bold; margin-bottom:4px; cursor:pointer; }
.input-area { display:flex; padding:10px; background:#000; gap:5px; }
input { flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#111; color:white; }
button { padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
.send { background:var(--red); color:white; }
.delete-btn { background:none; color:red; font-size:11px; border:none; cursor:pointer; margin-top:4px; }
.status-text { font-size:11px; color:gray; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#0a0a0a; padding:20px; border-radius:15px; z-index:2000; width:280px; text-align:center; }
.overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:1500; }
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="sidebar" id="menu">

<div class="nav-item active" onclick="switchRoom('ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜', this)">ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜</div>
<div class="nav-item" onclick="switchRoom('ğŸ’ VIP áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ‘áƒ˜', this)">ğŸ’ VIP áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ‘áƒ˜</div>
<div class="nav-item" onclick="switchRoom('ğŸ”’ áƒ¨áƒ˜áƒ¤áƒ áƒáƒ’áƒ áƒáƒ›áƒ', this)">ğŸ”’ áƒ¨áƒ˜áƒ¤áƒ áƒáƒ’áƒ áƒáƒ›áƒ</div>
<div class="nav-item" onclick="switchRoom('ğŸ¯ áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ', this)">ğŸ¯ áƒ•áƒ˜áƒ¥áƒ¢áƒáƒ áƒ˜áƒœáƒ</div>
<div class="nav-item" onclick="switchRoom('ğŸª¢ áƒ©áƒáƒ›áƒáƒ®áƒ áƒ©áƒáƒ‘áƒáƒœáƒ', this)">ğŸª¢ áƒ©áƒáƒ›áƒáƒ®áƒ áƒ©áƒáƒ‘áƒáƒœáƒ</div>
<div class="nav-item" onclick="switchRoom('ğŸ˜‚ áƒ˜áƒ£áƒ›áƒáƒ áƒ˜', this)">ğŸ˜‚ áƒ˜áƒ£áƒ›áƒáƒ áƒ˜</div>
<div class="nav-item" onclick="switchRoom('ğŸµ áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ', this)">ğŸµ áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ</div>
<div class="nav-item" onclick="switchRoom('ğŸ–¼ï¸ áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ', this)">ğŸ–¼ï¸ áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ</div>
<div class="nav-item" onclick="switchRoom('â“ áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ', this)">â“ áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ</div>
<div class="nav-item" onclick="switchRoom('ğŸ›¡ï¸ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ', this)">ğŸ›¡ï¸ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ</div>

<button onclick="logout()" style="margin-top:20px;background:#111;color:white;width:100%;">áƒ’áƒáƒ¡áƒ•áƒšáƒ</button>

</div>

<header>
<div onclick="openMenu()" style="cursor:pointer;color:var(--red)">â˜°</div>
<div id="room-title">ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜</div>
<div onclick="openProfile(myNick)" id="myNick" style="color:var(--red);cursor:pointer"></div>
</header>

<div id="chat-window"></div>

<div class="input-area">
<input type="file" id="fileInput" hidden accept="image/*" onchange="uploadImage(this)">
<button onclick="document.getElementById('fileInput').click()">ğŸ“·</button>
<input type="text" id="msgInput">
<button class="send" onclick="sendMsg()">â¤</button>
</div>

<div class="modal" id="profileModal">
<h3 id="pNick"></h3>
<p id="pRole"></p>
<p id="pStatus" class="status-text"></p>

<div id="adminTools" style="display:none;">
<button onclick="setRole('admin')">áƒáƒ“áƒ›áƒ˜áƒœáƒ˜</button>
<button onclick="setRole('owner')">Owner</button>
</div>

<div id="myTools" style="display:none;">
<input id="statusInput" placeholder="áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜">
<button onclick="updateStatus()">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ</button>
</div>

<button onclick="closeAll()" style="margin-top:10px;background:none;color:gray;">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
</div>

<script>
const { createClient } = supabase;

const sb = createClient(
"https://ftfciebnywbondaiarnc.supabase.co",
"sb_publishable_eQZDSu_Jy1gWmXJFF800Pw_TP2kBRLI"
);

let myNick = localStorage.getItem("username");
let currentRoom = "ğŸ’¬ áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ©áƒáƒ¢áƒ˜";
let users = {};
let myRole = "user";

if(!myNick) location.href="index.html";
document.getElementById("myNick").innerText=myNick;

async function init(){
await loadUsers();
loadMessages();
}

async function loadUsers(){
const { data } = await sb.from("user_profiles").select("*");
if(data){
data.forEach(u=>users[u.nickname]=u);
myRole = users[myNick]?.role || "user";
}
}

async function loadMessages(){
const { data } = await sb.from("messages_v3")
.select("*")
.eq("room_name",currentRoom)
.order("created_at",{ascending:true})
.limit(50);

const box=document.getElementById("chat-window");
box.innerHTML="";
if(data){
data.forEach(m=>{
const role = users[m.nickname]?.role;
let color = role==="owner"?"var(--gold)":role==="admin"?"#00ccff":"var(--red)";
box.innerHTML+=`
<div class="msg">
<div class="sender" style="color:${color}" onclick="openProfile('${m.nickname}')">${m.nickname}</div>
${m.message.startsWith("http")?`<img src="${m.message}" style="max-width:100%;border-radius:8px;">`:`<div>${m.message}</div>`}
${(myRole==="owner"||myRole==="admin")?`<button class="delete-btn" onclick="deleteMsg('${m.id}')">áƒ¬áƒáƒ¨áƒšáƒ</button>`:""}
</div>`;
});
box.scrollTop=box.scrollHeight;
}
}

async function sendMsg(){
let text=document.getElementById("msgInput").value.trim();
if(!text) return;
document.getElementById("msgInput").value="";
await sb.from("messages_v3").insert([{nickname:myNick,message:text,room_name:currentRoom}]);
loadMessages();
}

async function deleteMsg(id){
await sb.from("messages_v3").delete().eq("id",id);
loadMessages();
}

async function uploadImage(input){
const file=input.files[0];
if(!file) return;
const fileName=Date.now()+"_"+file.name;
await sb.storage.from("chat-images").upload(fileName,file);
const { data }=sb.storage.from("chat-images").getPublicUrl(fileName);
await sb.from("messages_v3").insert([{nickname:myNick,message:data.publicUrl,room_name:currentRoom}]);
loadMessages();
}

function switchRoom(name,el){
currentRoom=name;
document.getElementById("room-title").innerText=name;
document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
el.classList.add("active");
closeAll();
loadMessages();
}

function openMenu(){document.getElementById("menu").classList.add("open");document.getElementById("overlay").style.display="block";}
function closeAll(){document.getElementById("menu").classList.remove("open");document.getElementById("overlay").style.display="none";document.getElementById("profileModal").style.display="none";}

function openProfile(nick){
const u=users[nick]||{};
document.getElementById("pNick").innerText=nick;
document.getElementById("pRole").innerText=u.role||"user";
document.getElementById("pStatus").innerText=u.status||"";
document.getElementById("adminTools").style.display=(myRole==="owner"&&nick!==myNick)?"block":"none";
document.getElementById("myTools").style.display=(nick===myNick)?"block":"none";
document.getElementById("profileModal").style.display="block";
document.getElementById("overlay").style.display="block";
window.targetUser=nick;
}

async function setRole(role){
if(myRole!=="owner") return;
await sb.from("user_profiles").upsert({nickname:window.targetUser,role:role});
alert("áƒ¨áƒ”áƒªáƒ•áƒšáƒ˜áƒšáƒ˜áƒ");
location.reload();
}

async function updateStatus(){
let val=document.getElementById("statusInput").value.trim();
await sb.from("user_profiles").upsert({nickname:myNick,status:val});
alert("áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ");
location.reload();
}

function logout(){localStorage.removeItem("username");location.href="index.html";}

sb.channel("live")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages_v3"},loadMessages)
.subscribe();

init();
</script>
</body>
</html>
